<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Modern Google Maps with JSON Locations</title>
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #info-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 100;
      max-width: 300px;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      background: white;
      padding: 20px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="info-panel">Click on a marker for details</div>
  <div id="loading" class="loading">Loading map and locations...</div>
  <div id="map"></div>

  <script>
    const config = {
      apiKey: import.meta.env.GOOGLE_API_KEY, // Your API key here
      mapId: 'YOUR_MAP_ID', // Optional
      center: { lat: 36.77, lng: -121.41 },
      zoom: 8
    };

    let map;
    let infoWindow;

    function buildPhotoUrl(photoName, maxWidth = 400) {
      return `https://maps.googleapis.com/maps/api/place/photo?maxwidth=${maxWidth}&photoreference=${encodeURIComponent(photoName)}&key=${config.apiKey}`;
    }

    async function loadGoogleMapsScript() {
      if (window.google && window.google.maps) {
        return;
      }

      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = `https://maps.googleapis.com/maps/api/js?key=${config.apiKey}&libraries=places,marker&v=beta`;
        script.async = true;
        script.defer = true;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    async function loadLocations() {
      const response = await fetch('dealerships_with_places.json');
      if (!response.ok) {
        throw new Error('Failed to load locations JSON');
      }
      return await response.json();
    }

    async function initMapWithLocations(locations) {
      try {
        const { Map } = await google.maps.importLibrary("maps");
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
        const { Place } = await google.maps.importLibrary("places");

        document.getElementById('loading').style.display = 'none';

        map = new Map(document.getElementById("map"), {
          center: config.center,
          zoom: config.zoom,
          mapId: config.mapId
        });

        infoWindow = new google.maps.InfoWindow();

        for (const location of locations) {
          const place = new Place({
            id: location.placeId,
            requestedLanguage: 'en'
          });

          await place.fetchFields({
            fields: [
              "displayName",
              "formattedAddress",
              "location",
              "rating",
              "userRatingCount",
              "photos",
              "id"
            ]
          });

          const marker = new AdvancedMarkerElement({
            map,
            position: place.location,
            title: place.displayName
          });

          marker.addListener("click", () => {
            showPlaceDetails(place, marker);
          });
        }
      } catch (error) {
        console.error("Error initializing map:", error);
        document.getElementById('loading').textContent = "Error loading map. Please try again.";
      }
    }

    function showPlaceDetails(place, marker) {
      let photoUrl = '';
      if (place.photos && place.photos.length > 0) {
        photoUrl = buildPhotoUrl(place.photos[0].name);
      }

      const content = `
        <div style="padding: 10px;">
          <h3>${place.displayName}</h3>
          ${place.rating ? `<p>Rating: ${place.rating} (${place.userRatingCount} reviews)</p>` : ''}
          ${place.formattedAddress ? `<p>Address: ${place.formattedAddress}</p>` : ''}
          <p><a href="https://www.google.com/maps/place/?q=place_id:${place.id}" target="_blank" rel="noopener">View on Google Maps</a></p>
          ${photoUrl ? `<img src="${photoUrl}" style="max-width: 100%; margin-top: 8px;">` : ''}
        </div>
      `;

      infoWindow.setContent(content);
      infoWindow.open({
        anchor: marker,
        map
      });

      document.getElementById('info-panel').innerHTML = `
        <h3>${place.displayName}</h3>
        ${place.formattedAddress ? `<p>${place.formattedAddress}</p>` : ''}
        ${place.rating ? `<p>â˜… ${place.rating} (${place.userRatingCount} reviews)</p>` : ''}
      `;
    }

    (async () => {
      try {
        await loadGoogleMapsScript();
        const locations = await loadLocations();
        await initMapWithLocations(locations);
      } catch (error) {
        console.error("Failed to load Google Maps JS API or locations:", error);
        document.getElementById('loading').textContent = "Failed to load Google Maps API or locations. Please check your API key and network.";
      }
    })();
  </script>
</body>
</html>
