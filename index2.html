<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Google Maps with Enriched JSON Locations</title>
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #info-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 100;
      max-width: 300px;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      background: white;
      padding: 20px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="info-panel">Click on a marker for details</div>
  <div id="loading" class="loading">Loading map and locations...</div>
  <div id="map"></div>

  <script>
    const config = {
      apiKey: 'AIzaSyC6KDgRCgr8uAipghnPRpaCLREyWUhtKb0', // Your API key here
      mapId: 'YOUR_MAP_ID', // Optional
      center: { lat: 36.77, lng: -121.41 },
      zoom: 8
    };

    let map;
    let infoWindow;

    async function loadGoogleMapsScript() {
      if (window.google && window.google.maps) return;

      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = `https://maps.googleapis.com/maps/api/js?key=${config.apiKey}&v=beta`;
        script.async = true;
        script.defer = true;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    async function loadLocations() {
      const response = await fetch('enriched_dealerships.json'); // your enriched JSON file
      if (!response.ok) {
        throw new Error('Failed to load locations JSON');
      }
      return await response.json();
    }

    function createMarker(locationData) {
      const marker = new google.maps.Marker({
        position: {
          lat: locationData.geometry.location.lat,
          lng: locationData.geometry.location.lng,
        },
        map,
        title: locationData.name,
      });

      marker.addListener("click", () => {
        showPlaceDetails(locationData, marker);
      });
    }

    function showPlaceDetails(place, marker) {
      const websiteLink = place.website ? `<p><a href="${place.website}" target="_blank" rel="noopener">Website</a></p>` : '';
      const content = `
        <div style="padding: 10px; max-width: 250px;">
          <h3>${place.name}</h3>
          ${place.rating ? `<p>Rating: ${place.rating}</p>` : ''}
          ${place.formatted_address ? `<p>Address: ${place.formatted_address}</p>` : ''}
          ${websiteLink}
          <p><a href="https://www.google.com/maps/place/?q=place_id:${place.place_id}" target="_blank" rel="noopener">View on Google Maps</a></p>
        </div>
      `;

      infoWindow.setContent(content);
      infoWindow.open({
        anchor: marker,
        map,
      });

      document.getElementById('info-panel').innerHTML = `
        <h3>${place.name}</h3>
        ${place.formatted_address ? `<p>${place.formatted_address}</p>` : ''}
        ${place.rating ? `<p>â˜… ${place.rating}</p>` : ''}
        ${websiteLink}
      `;
    }

    /*async function initMapWithLocations(locations) {
      document.getElementById('loading').style.display = 'none';

      map = new google.maps.Map(document.getElementById("map"), {
        center: config.center,
        zoom: config.zoom,
        mapId: config.mapId
      });

      infoWindow = new google.maps.InfoWindow();

      for (const location of locations) {
        createMarker(location);
      }
    }*/
    async function initMapWithLocations(locations) {
      try {
        const { Map } = await google.maps.importLibrary("maps");
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
        const { Place } = await google.maps.importLibrary("places");

        document.getElementById('loading').style.display = 'none';

        map = new Map(document.getElementById("map"), {
          center: config.center,
          zoom: config.zoom,
          mapId: config.mapId
        });

        infoWindow = new google.maps.InfoWindow();

        for (const location of locations) {
          const place = new Place({
            id: location.placeId,
            requestedLanguage: 'en'
          });

          await place.fetchFields({
            fields: [
              "displayName",
              "formattedAddress",
              "location",
              "rating",
              "userRatingCount",
              "photos",
              "id"
            ]
          });

          const marker = new AdvancedMarkerElement({
            map,
            position: place.location,
            title: place.displayName
          });

          marker.addListener("click", () => {
            showPlaceDetails(place, marker);
          });
        }
      } catch (error) {
        console.error("Error initializing map:", error);
        document.getElementById('loading').textContent = "Error loading map. Please try again.";
      }
    }

    (async () => {
      try {
        await loadGoogleMapsScript();
        const locations = await loadLocations();
        await initMapWithLocations(locations);
      } catch (error) {
        console.error("Failed to load Google Maps JS API or locations:", error);
        document.getElementById('loading').textContent = "Failed to load Google Maps API or locations. Please check your API key and network.";
      }
    })();
  </script>
</body>
</html>
